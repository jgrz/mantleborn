<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crucible of Code | Mantleborn Game Wizard</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0d0d14;
            --bg-mid: #1a1a2e;
            --bg-surface: #252542;
            --accent-ember: #e07020;
            --accent-ember-glow: #ff9040;
            --accent-gold: #ffa500;
            --accent-gold-glow: #ffcc00;
            --crucible-bronze: #7a5a3a;
            --crucible-bronze-light: #9a7a5a;
            --stone-dark: #3a3a5c;
            --stone-mid: #6a6a8e;
            --stone-light: #9a9abe;
            --stone-bright: #d0d0e8;
            --success: #30d158;
            --error: #ff453a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-deep);
            color: var(--stone-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-mid);
            border-bottom: 1px solid var(--stone-dark);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .home-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            font-size: 18px;
            text-decoration: none;
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 4px;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: var(--stone-dark);
            border-color: var(--accent-gold);
        }

        .brand-icon {
            font-size: 24px;
            filter: drop-shadow(0 0 8px rgba(255, 165, 0, 0.6));
        }

        .brand-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            color: var(--stone-mid);
            letter-spacing: 1px;
        }

        .brand-text span {
            color: var(--accent-gold);
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
        }

        .project-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .project-dropdown {
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            color: var(--stone-light);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            min-width: 200px;
            cursor: pointer;
        }

        .project-dropdown:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .btn {
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            color: var(--stone-light);
            padding: 8px 16px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--stone-dark);
            border-color: var(--stone-mid);
        }

        .btn-primary {
            background: var(--crucible-bronze);
            border-color: var(--crucible-bronze-light);
            color: var(--stone-bright);
        }

        .btn-primary:hover {
            background: var(--crucible-bronze-light);
            border-color: var(--accent-gold);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .auth-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 4px;
            font-size: 11px;
            color: var(--stone-mid);
        }

        .auth-indicator.logged-in {
            border-color: var(--crucible-bronze);
            color: var(--stone-light);
        }

        .auth-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--stone-dark);
        }

        .auth-indicator.logged-in .auth-dot {
            background: var(--success);
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-mid);
            border-right: 1px solid var(--stone-dark);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid var(--stone-dark);
        }

        .sidebar-section-header {
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            color: var(--stone-mid);
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .levels-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .level-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-surface);
            border: 1px solid transparent;
            border-radius: 4px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .level-item:hover {
            border-color: var(--stone-dark);
        }

        .level-item.active {
            border-color: var(--accent-gold);
            background: rgba(255, 165, 0, 0.1);
        }

        .level-item-name {
            font-size: 12px;
            color: var(--stone-bright);
        }

        .level-item-meta {
            font-size: 9px;
            color: var(--stone-mid);
        }

        .level-item-delete {
            opacity: 0;
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            transition: opacity 0.2s;
        }

        .level-item:hover .level-item-delete {
            opacity: 0.6;
        }

        .level-item-delete:hover {
            opacity: 1 !important;
        }

        .new-level-btn {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border-style: dashed;
            color: var(--stone-mid);
        }

        .new-level-btn:hover {
            color: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Dashboard */
        .dashboard {
            padding: 24px;
            overflow-y: auto;
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .level-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            color: var(--stone-bright);
        }

        .level-subtitle {
            font-size: 11px;
            color: var(--stone-mid);
            margin-top: 8px;
        }

        /* Component Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .status-card {
            background: var(--bg-mid);
            border: 1px solid var(--stone-dark);
            border-radius: 8px;
            padding: 16px;
        }

        .status-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .status-card-title {
            font-size: 11px;
            color: var(--stone-mid);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-card-icon {
            font-size: 20px;
        }

        .status-bar {
            height: 8px;
            background: var(--bg-deep);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .status-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--crucible-bronze), var(--accent-gold));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .status-card-value {
            font-size: 12px;
            color: var(--stone-bright);
        }

        .status-card-meta {
            font-size: 10px;
            color: var(--stone-mid);
            margin-top: 4px;
        }

        .status-card.empty .status-bar-fill {
            width: 0 !important;
            background: var(--stone-dark);
        }

        .status-card.empty .status-card-value {
            color: var(--stone-mid);
        }

        /* Open in Tool button */
        .open-tool-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 6px 12px;
            font-size: 10px;
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 4px;
            color: var(--stone-light);
            text-decoration: none;
            transition: all 0.2s;
        }

        .open-tool-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Data Tabs */
        .data-tabs {
            display: flex;
            gap: 4px;
            padding: 0 24px;
            border-bottom: 1px solid var(--stone-dark);
        }

        .data-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--stone-mid);
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .data-tab:hover {
            color: var(--stone-light);
        }

        .data-tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .data-panel {
            display: none;
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .data-panel.active {
            display: block;
        }

        /* JSON Preview */
        .json-preview {
            background: var(--bg-mid);
            border: 1px solid var(--stone-dark);
            border-radius: 8px;
            overflow: hidden;
        }

        .json-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--stone-dark);
        }

        .json-preview-title {
            font-size: 11px;
            color: var(--stone-mid);
        }

        .json-preview-content {
            padding: 16px;
            max-height: 400px;
            overflow: auto;
            font-size: 11px;
            line-height: 1.5;
            color: var(--stone-light);
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            color: var(--stone-bright);
            margin-bottom: 12px;
        }

        .empty-state-text {
            font-size: 12px;
            color: var(--stone-mid);
            max-width: 400px;
            line-height: 1.6;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-mid);
            border: 1px solid var(--stone-dark);
            border-radius: 12px;
            padding: 24px;
            min-width: 360px;
            max-width: 90vw;
        }

        .modal-header {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: var(--stone-bright);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 10px;
            color: var(--stone-mid);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 4px;
            color: var(--stone-light);
            font-family: inherit;
            font-size: 12px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-mid);
            border: 1px solid var(--stone-dark);
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 12px;
            color: var(--stone-light);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--error);
        }

        /* Not Configured Warning */
        .config-warning {
            background: rgba(255, 69, 58, 0.1);
            border: 1px solid var(--error);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .config-warning-title {
            font-size: 12px;
            color: var(--error);
            margin-bottom: 8px;
        }

        .config-warning-text {
            font-size: 11px;
            color: var(--stone-light);
            line-height: 1.5;
        }

        .config-warning code {
            background: var(--bg-deep);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        /* Grid Preview */
        .grid-preview {
            display: grid;
            gap: 1px;
            background: var(--stone-dark);
            border: 1px solid var(--stone-dark);
            border-radius: 4px;
            overflow: hidden;
            max-width: 100%;
            max-height: 300px;
        }

        .grid-preview-cell {
            width: 8px;
            height: 8px;
            background: var(--bg-deep);
        }

        .grid-preview-cell.open {
            background: var(--bg-surface);
        }

        .grid-preview-cell.obstruction {
            background: var(--crucible-bronze);
        }

        .grid-preview-cell.spawn {
            background: var(--success);
        }

        /* Background Preview */
        .bg-preview {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .bg-layer-card {
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 8px;
            padding: 12px;
            width: 180px;
        }

        .bg-layer-thumb {
            width: 100%;
            height: 100px;
            background: var(--bg-deep);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .bg-layer-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: pixelated;
        }

        .bg-layer-name {
            font-size: 11px;
            color: var(--stone-bright);
            margin-bottom: 4px;
        }

        .bg-layer-meta {
            font-size: 9px;
            color: var(--stone-mid);
        }

        /* Settings Modal */
        .modal-wide {
            min-width: 520px;
            max-width: 600px;
        }

        .settings-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--stone-dark);
        }

        .settings-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            color: var(--stone-mid);
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .settings-tab:hover {
            color: var(--stone-light);
        }

        .settings-tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 11px;
            color: var(--stone-mid);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--stone-dark);
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .settings-row-label {
            font-size: 12px;
            color: var(--stone-light);
        }

        .settings-row-hint {
            font-size: 10px;
            color: var(--stone-mid);
            margin-top: 2px;
        }

        .settings-select {
            padding: 8px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 4px;
            color: var(--stone-light);
            font-family: inherit;
            font-size: 11px;
            min-width: 160px;
            cursor: pointer;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .settings-number {
            width: 80px;
            padding: 8px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 4px;
            color: var(--stone-light);
            font-family: inherit;
            font-size: 11px;
            text-align: center;
        }

        .settings-number:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .preset-preview {
            background: var(--bg-surface);
            border: 1px solid var(--stone-dark);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .preset-preview-title {
            font-size: 10px;
            color: var(--stone-mid);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .preset-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .preset-preview-item {
            font-size: 10px;
            color: var(--stone-light);
        }

        .preset-preview-item span {
            color: var(--accent-gold);
        }

        /* Project Wizard Modal */
        .modal-wizard {
            min-width: 580px;
            max-width: 640px;
        }

        .wizard-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .wizard-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            color: var(--stone-mid);
        }

        .wizard-step.active {
            color: var(--accent-gold);
        }

        .wizard-step.completed {
            color: var(--success);
        }

        .wizard-step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 2px solid var(--stone-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .wizard-step.active .wizard-step-num {
            border-color: var(--accent-gold);
            background: rgba(255, 165, 0, 0.1);
        }

        .wizard-step.completed .wizard-step-num {
            border-color: var(--success);
            background: var(--success);
            color: #fff;
        }

        .wizard-step-line {
            width: 40px;
            height: 2px;
            background: var(--stone-dark);
        }

        .wizard-step.completed + .wizard-step-line,
        .wizard-step.active + .wizard-step-line {
            background: var(--accent-gold);
        }

        .wizard-panel {
            display: none;
        }

        .wizard-panel.active {
            display: block;
        }

        .wizard-subtitle {
            font-size: 11px;
            color: var(--stone-mid);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Visual Example Cards */
        .example-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .example-card {
            background: var(--bg-surface);
            border: 2px solid var(--stone-dark);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .example-card:hover {
            border-color: var(--stone-mid);
        }

        .example-card.selected {
            border-color: var(--accent-gold);
            background: rgba(255, 165, 0, 0.05);
        }

        .example-card-visual {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .example-card-label {
            font-size: 10px;
            color: var(--stone-bright);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .example-card-desc {
            font-size: 9px;
            color: var(--stone-mid);
            line-height: 1.4;
        }

        /* View perspective examples with pixel art style */
        .example-visual-topdown {
            width: 40px;
            height: 40px;
            background: linear-gradient(180deg, #4a7c59 0%, #3d6b4a 100%);
            border: 2px solid #2d4a36;
            border-radius: 4px;
            position: relative;
        }

        .example-visual-topdown::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: #e8c170;
            border: 2px solid #c9a050;
            border-radius: 50%;
        }

        .example-visual-side {
            width: 24px;
            height: 40px;
            background: linear-gradient(180deg, #5a8fd8 20%, #4a7cc8 20%, #4a7cc8 100%);
            border: 2px solid #3a5c8a;
            border-radius: 4px 4px 0 0;
            position: relative;
        }

        .example-visual-side::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: -8px;
            right: -8px;
            height: 12px;
            background: #5d4e37;
            border: 2px solid #4a3d2a;
        }

        .example-visual-iso {
            width: 48px;
            height: 32px;
            background: linear-gradient(135deg, #6a8caf 0%, #5a7c9f 50%, #4a6c8f 100%);
            transform: skewX(-10deg);
            border: 2px solid #3a5c7a;
        }

        /* Outline examples */
        .example-outline-none {
            width: 32px;
            height: 32px;
            background: #e07020;
            border-radius: 4px;
        }

        .example-outline-black {
            width: 32px;
            height: 32px;
            background: #e07020;
            border: 3px solid #000;
            border-radius: 4px;
        }

        .example-outline-colored {
            width: 32px;
            height: 32px;
            background: #e07020;
            border: 3px solid #8a4010;
            border-radius: 4px;
        }

        /* Shading examples */
        .example-shading-flat {
            width: 32px;
            height: 32px;
            background: #4a7cc8;
            border: 2px solid #000;
            border-radius: 4px;
        }

        .example-shading-basic {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #5a8cd8 0%, #4a7cc8 50%, #3a6cb8 100%);
            border: 2px solid #000;
            border-radius: 4px;
        }

        .example-shading-detailed {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #7aadf8 0%, #5a8cd8 25%, #4a7cc8 50%, #3a6cb8 75%, #2a5ca8 100%);
            border: 2px solid #000;
            border-radius: 4px;
            box-shadow: inset 2px 2px 0 rgba(255,255,255,0.3), inset -2px -2px 0 rgba(0,0,0,0.2);
        }

        .wizard-section {
            margin-bottom: 24px;
        }

        .wizard-section-title {
            font-size: 11px;
            color: var(--stone-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wizard-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--stone-dark);
        }

        .wizard-tip {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 6px;
            padding: 12px;
            font-size: 11px;
            color: var(--stone-light);
            line-height: 1.5;
        }

        .wizard-tip-icon {
            color: var(--accent-gold);
            margin-right: 6px;
        }

        .wizard-section-desc {
            font-size: 11px;
            color: var(--stone-mid);
            margin-bottom: 12px;
            margin-top: -8px;
        }

        .style-row {
            display: flex;
            gap: 32px;
        }

        .style-group {
            flex: 1;
        }

        .style-group-label {
            font-size: 10px;
            color: var(--stone-mid);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .style-options {
            display: flex;
            gap: 8px;
        }

        .style-option {
            width: 48px;
            height: 48px;
            padding: 4px;
            background: var(--bg-mid);
            border: 2px solid var(--stone-dark);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .style-option:hover {
            border-color: var(--stone-mid);
            background: var(--bg-surface);
        }

        .style-option.selected {
            border-color: var(--accent-gold);
            background: rgba(255, 165, 0, 0.1);
        }

        .style-swatch {
            width: 100%;
            height: 100%;
            border-radius: 3px;
        }

        /* Outline swatches */
        .style-swatch-nooutline {
            background: linear-gradient(135deg, #e07840 25%, #c05820 75%);
        }

        .style-swatch-blackoutline {
            background: linear-gradient(135deg, #e07840 25%, #c05820 75%);
            box-shadow: inset 0 0 0 2px #1a1a2e, inset 0 0 0 3px #000;
        }

        .style-swatch-coloredoutline {
            background: linear-gradient(135deg, #e07840 25%, #c05820 75%);
            box-shadow: inset 0 0 0 2px #1a1a2e, inset 0 0 0 3px #8a4010;
        }

        /* Shading swatches */
        .style-swatch-flat {
            background: #5080c0;
        }

        .style-swatch-basic {
            background: linear-gradient(135deg, #70a0e0 0%, #5080c0 50%, #3060a0 100%);
        }

        .style-swatch-detailed {
            background: linear-gradient(135deg, #90c0f0 0%, #70a0e0 25%, #5080c0 50%, #3060a0 75%, #204080 100%);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <span class="brand-icon">&#129516;</span>
            <span class="brand-text">CRUCIBLE</span>
        </div>
        <div class="header-actions" id="headerActions">
            <button class="btn btn-primary" id="newProjectBtn">+ New Project</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-section-header">PROJECT</div>
                <div id="projectInfo">
                    <div style="font-size: 12px; color: var(--stone-mid);">No project selected</div>
                </div>
                <button class="btn" id="projectSettingsBtn" style="width: 100%; margin-top: 12px;" disabled>
                    &#9881; Project Settings
                </button>
                <button class="btn" id="exportProjectBtn" style="width: 100%; margin-top: 8px;" disabled>
                    &#128230; Export Project
                </button>
                <button class="btn" id="inviteBtn" style="width: 100%; margin-top: 8px;" disabled>
                    &#128231; Invite Collaborator
                </button>
                <div id="membersList" style="margin-top: 12px; display: none;"></div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-header">LEVELS</div>
            </div>
            <div class="levels-list" id="levelsList">
                <div class="empty-state" style="padding: 20px;">
                    <div style="font-size: 11px; color: var(--stone-mid);">Select a project to view levels</div>
                </div>
            </div>
            <div style="padding: 8px;">
                <button class="btn new-level-btn" id="newLevelBtn" disabled>+ New Level</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Empty State (no level selected) -->
            <div class="empty-state" id="emptyState">
                <div class="empty-state-icon">&#129516;</div>
                <div class="empty-state-title">CRUCIBLE OF CODE</div>
                <div class="empty-state-text">
                    Select a project and level to begin, or create a new one. The Crucible combines data from all Game Wizard tools into playable levels.
                </div>
            </div>

            <!-- Dashboard (level selected) -->
            <div class="dashboard" id="dashboard" style="display: none;">
                <!-- Config Warning -->
                <div class="config-warning" id="configWarning" style="display: none;">
                    <div class="config-warning-title">Supabase Not Configured</div>
                    <div class="config-warning-text">
                        Edit <code>game-wizard/shared/supabase-client.js</code> and add your Supabase URL and anon key.
                        Run the SQL in <code>game-wizard/shared/setup-supabase.sql</code> to create the database tables.
                    </div>
                </div>

                <div class="dashboard-header">
                    <div>
                        <div class="level-title" id="levelTitle">Level Name</div>
                        <div class="level-subtitle" id="levelSubtitle">32x18 tiles • Platformer</div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" id="copyJsonBtn">Copy JSON</button>
                        <button class="btn btn-primary" id="exportBtn">Export Level</button>
                    </div>
                </div>

                <!-- Status Cards -->
                <div class="status-grid">
                    <div class="status-card" id="gridStatus">
                        <div class="status-card-header">
                            <span class="status-card-title">Collision Grid</span>
                            <span class="status-card-icon">&#128506;</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="status-card-value">Not defined</div>
                        <div class="status-card-meta">0 obstructions • 0 walkable</div>
                        <a href="#" class="open-tool-btn" id="openLevelForgeGrid">
                            Open in Level Forge &#8594;
                        </a>
                    </div>

                    <div class="status-card" id="bgStatus">
                        <div class="status-card-header">
                            <span class="status-card-title">Backgrounds</span>
                            <span class="status-card-icon">&#127748;</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="status-card-value">No layers</div>
                        <div class="status-card-meta">Add parallax backgrounds</div>
                        <a href="#" class="open-tool-btn" id="openLevelForgeBg">
                            Open in Level Forge &#8594;
                        </a>
                    </div>

                    <div class="status-card" id="tilesStatus">
                        <div class="status-card-header">
                            <span class="status-card-title">Visual Tiles</span>
                            <span class="status-card-icon">&#129521;</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="status-card-value">0 tiles placed</div>
                        <div class="status-card-meta">Paint sprites on grid</div>
                        <a href="#" class="open-tool-btn" id="openLevelForgeTiles">
                            Open in Level Forge &#8594;
                        </a>
                    </div>

                    <div class="status-card empty" id="spawnStatus">
                        <div class="status-card-header">
                            <span class="status-card-title">Spawn Point</span>
                            <span class="status-card-icon">&#127919;</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="status-card-value">Not set</div>
                        <div class="status-card-meta">Player start position</div>
                    </div>
                </div>

                <!-- Data Tabs -->
                <div class="data-tabs">
                    <button class="data-tab active" data-tab="grid">Grid</button>
                    <button class="data-tab" data-tab="backgrounds">Backgrounds</button>
                    <button class="data-tab" data-tab="tiles">Tiles</button>
                    <button class="data-tab" data-tab="json">JSON</button>
                </div>

                <!-- Tab Panels -->
                <div class="data-panel active" id="gridPanel">
                    <h3 style="font-size: 12px; margin-bottom: 16px; color: var(--stone-mid);">Grid Preview</h3>
                    <div class="grid-preview" id="gridPreview">
                        <div style="padding: 40px; text-align: center; color: var(--stone-mid); font-size: 11px;">
                            No grid data. Open in Level Forge to design collision.
                        </div>
                    </div>
                </div>

                <div class="data-panel" id="backgroundsPanel">
                    <h3 style="font-size: 12px; margin-bottom: 16px; color: var(--stone-mid);">Background Layers</h3>
                    <div class="bg-preview" id="bgPreview">
                        <div style="padding: 40px; text-align: center; color: var(--stone-mid); font-size: 11px;">
                            No background layers. Open in Level Forge to add parallax backgrounds.
                        </div>
                    </div>
                </div>

                <div class="data-panel" id="tilesPanel">
                    <h3 style="font-size: 12px; margin-bottom: 16px; color: var(--stone-mid);">Visual Tiles</h3>
                    <div id="tilesPreview">
                        <div style="padding: 40px; text-align: center; color: var(--stone-mid); font-size: 11px;">
                            No visual tiles placed. Open in Level Forge to paint tiles.
                        </div>
                    </div>
                </div>

                <div class="data-panel" id="jsonPanel">
                    <div class="json-preview">
                        <div class="json-preview-header">
                            <span class="json-preview-title">Compiled Level JSON</span>
                            <button class="btn" id="copyJsonBtn2" style="padding: 4px 12px; font-size: 10px;">Copy</button>
                        </div>
                        <div class="json-preview-content" id="jsonOutput">{}</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Project Modal (Two-Step Wizard) -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal modal-wizard">
            <div class="modal-header">New Project</div>

            <!-- Wizard Steps Indicator -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-num">1</div>
                    <span>Basics</span>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-num">2</div>
                    <span>Style</span>
                </div>
            </div>

            <!-- Step 1: Basic Info -->
            <div class="wizard-panel active" id="wizardStep1">
                <div class="wizard-subtitle">
                    Give your project a name and choose the primary view style for your game.
                </div>

                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="newProjectName" placeholder="My Game">
                </div>

                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <input type="text" class="form-input" id="newProjectDesc" placeholder="A platformer adventure">
                </div>

                <div class="wizard-section">
                    <div class="wizard-section-title">Game View</div>
                    <div class="example-grid" id="viewExamples">
                        <div class="example-card selected" data-value="side-scroll">
                            <div class="example-card-visual">
                                <div class="example-visual-side"></div>
                            </div>
                            <div class="example-card-label">Side-Scroller</div>
                            <div class="example-card-desc">Platformers, run & gun, beat 'em ups</div>
                        </div>
                        <div class="example-card" data-value="top-down">
                            <div class="example-card-visual">
                                <div class="example-visual-topdown"></div>
                            </div>
                            <div class="example-card-label">Top-Down</div>
                            <div class="example-card-desc">RPGs, adventure, puzzle games</div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn" id="cancelProjectBtn">Cancel</button>
                    <button class="btn btn-primary" id="wizardNextBtn">Next: Style Settings →</button>
                </div>
            </div>

            <!-- Step 2: AI Style Settings -->
            <div class="wizard-panel" id="wizardStep2">
                <div class="wizard-subtitle">
                    These settings help AI generation create consistent artwork. You can change them anytime and override per-generation.
                </div>

                <div class="wizard-section">
                    <div class="wizard-section-title">Character Style</div>
                    <div class="wizard-section-desc">For sprites, characters, and objects that need to stand out</div>
                    <div class="style-row">
                        <div class="style-group">
                            <div class="style-group-label">Outline</div>
                            <div class="style-options" id="charOutlineOptions">
                                <button class="style-option" data-value="no_outline" title="No Outline">
                                    <div class="style-swatch style-swatch-nooutline"></div>
                                </button>
                                <button class="style-option selected" data-value="single_color_black" title="Black Outline">
                                    <div class="style-swatch style-swatch-blackoutline"></div>
                                </button>
                                <button class="style-option" data-value="single_color_colored" title="Colored Outline">
                                    <div class="style-swatch style-swatch-coloredoutline"></div>
                                </button>
                            </div>
                        </div>
                        <div class="style-group">
                            <div class="style-group-label">Shading</div>
                            <div class="style-options" id="charShadingOptions">
                                <button class="style-option" data-value="flat" title="Flat">
                                    <div class="style-swatch style-swatch-flat"></div>
                                </button>
                                <button class="style-option selected" data-value="basic" title="Basic">
                                    <div class="style-swatch style-swatch-basic"></div>
                                </button>
                                <button class="style-option" data-value="detailed" title="Detailed">
                                    <div class="style-swatch style-swatch-detailed"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wizard-section">
                    <div class="wizard-section-title">Tile Style</div>
                    <div class="wizard-section-desc">For backgrounds, terrain, and tilesets that need to blend seamlessly</div>
                    <div class="style-row">
                        <div class="style-group">
                            <div class="style-group-label">Outline</div>
                            <div class="style-options" id="tileOutlineOptions">
                                <button class="style-option selected" data-value="no_outline" title="No Outline (Recommended)">
                                    <div class="style-swatch style-swatch-nooutline"></div>
                                </button>
                                <button class="style-option" data-value="single_color_black" title="Black Outline">
                                    <div class="style-swatch style-swatch-blackoutline"></div>
                                </button>
                                <button class="style-option" data-value="single_color_colored" title="Colored Outline">
                                    <div class="style-swatch style-swatch-coloredoutline"></div>
                                </button>
                            </div>
                        </div>
                        <div class="style-group">
                            <div class="style-group-label">Shading</div>
                            <div class="style-options" id="tileShadingOptions">
                                <button class="style-option" data-value="flat" title="Flat">
                                    <div class="style-swatch style-swatch-flat"></div>
                                </button>
                                <button class="style-option selected" data-value="basic" title="Basic">
                                    <div class="style-swatch style-swatch-basic"></div>
                                </button>
                                <button class="style-option" data-value="detailed" title="Detailed">
                                    <div class="style-swatch style-swatch-detailed"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wizard-tip">
                    <span class="wizard-tip-icon">&#128161;</span>
                    <strong>Tip:</strong> Characters typically have outlines to "pop" against backgrounds, while tiles often don't to ensure seamless tiling.
                </div>

                <div class="modal-actions">
                    <button class="btn" id="wizardBackBtn">← Back</button>
                    <button class="btn btn-primary" id="createProjectBtn">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Level Modal -->
    <div class="modal-overlay" id="newLevelModal">
        <div class="modal">
            <div class="modal-header">New Level</div>
            <div class="form-group">
                <label class="form-label">Level Name</label>
                <input type="text" class="form-input" id="newLevelName" placeholder="Level 1">
            </div>
            <div class="form-group">
                <label class="form-label">Level Type</label>
                <select class="form-input" id="newLevelType">
                    <option value="platformer">Platformer</option>
                    <option value="topdown">Top-Down</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Width (tiles)</label>
                    <input type="number" class="form-input" id="newLevelWidth" value="32" min="8" max="128">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Height (tiles)</label>
                    <input type="number" class="form-input" id="newLevelHeight" value="18" min="8" max="72">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" id="cancelLevelBtn">Cancel</button>
                <button class="btn btn-primary" id="createLevelBtn">Create Level</button>
            </div>
        </div>
    </div>

    <!-- Invite Collaborator Modal -->
    <div class="modal-overlay" id="inviteModal">
        <div class="modal">
            <div class="modal-header">Invite Collaborator</div>
            <div class="form-group">
                <label class="form-label">Email or Display Name</label>
                <input type="text" class="form-input" id="inviteIdentifier" placeholder="friend@email.com or DisplayName">
            </div>
            <p style="font-size: 11px; color: var(--stone-mid); margin-bottom: 16px;">
                They'll receive a notification to join your project.
            </p>
            <div class="modal-actions">
                <button class="btn" id="cancelInviteBtn">Cancel</button>
                <button class="btn btn-primary" id="sendInviteBtn">Send Invite</button>
            </div>
        </div>
    </div>

    <!-- Project Settings Modal -->
    <div class="modal-overlay" id="projectSettingsModal">
        <div class="modal modal-wide">
            <div class="modal-header">Project Settings</div>

            <div class="settings-tabs">
                <button class="settings-tab active" data-settings-tab="general">General</button>
                <button class="settings-tab" data-settings-tab="ai">AI Generation</button>
                <button class="settings-tab" data-settings-tab="assets">Asset Defaults</button>
            </div>

            <!-- General Settings -->
            <div class="settings-panel active" id="settingsGeneral">
                <div class="settings-section">
                    <div class="settings-section-title">Project Info</div>
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" id="settingsProjectName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="settingsProjectDesc" placeholder="A brief description...">
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">Game Type</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Primary View</div>
                            <div class="settings-row-hint">Default perspective for this project</div>
                        </div>
                        <select class="settings-select" id="settingsGameView">
                            <option value="top-down">Top-Down</option>
                            <option value="side-scroll">Side-Scroller</option>
                            <option value="isometric">Isometric</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- AI Generation Settings -->
            <div class="settings-panel" id="settingsAI">
                <div class="settings-section">
                    <div class="settings-section-title">Style Presets</div>
                    <p style="font-size: 11px; color: var(--stone-mid); margin-bottom: 16px;">
                        These defaults pre-fill AI generation forms. You can override them per-generation.
                    </p>

                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Outline</div>
                            <div class="settings-row-hint">Edge style for generated sprites</div>
                        </div>
                        <select class="settings-select" id="settingsOutline">
                            <option value="none">No Outline</option>
                            <option value="single_color_black">Black Outline</option>
                            <option value="single_color_colored">Colored Outline</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Shading</div>
                            <div class="settings-row-hint">Depth and lighting style</div>
                        </div>
                        <select class="settings-select" id="settingsShading">
                            <option value="flat">Flat (No Shading)</option>
                            <option value="basic">Basic Shading</option>
                            <option value="detailed">Detailed Shading</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Detail Level</div>
                            <div class="settings-row-hint">Amount of visual detail</div>
                        </div>
                        <select class="settings-select" id="settingsDetail">
                            <option value="low">Low Detail</option>
                            <option value="medium">Medium Detail</option>
                            <option value="high">High Detail</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">View Perspective</div>
                            <div class="settings-row-hint">Default camera angle for sprites</div>
                        </div>
                        <select class="settings-select" id="settingsView">
                            <option value="high_top_down">High Top-Down</option>
                            <option value="low_top_down">Low Top-Down</option>
                            <option value="side">Side View</option>
                            <option value="isometric_thin">Isometric (Thin)</option>
                            <option value="isometric_thick">Isometric (Thick)</option>
                            <option value="isometric_block">Isometric (Block)</option>
                        </select>
                    </div>
                </div>

                <div class="preset-preview">
                    <div class="preset-preview-title">Current Style Preview</div>
                    <div class="preset-preview-grid" id="stylePreviewGrid">
                        <div class="preset-preview-item">Outline: <span id="previewOutline">Black</span></div>
                        <div class="preset-preview-item">Shading: <span id="previewShading">Basic</span></div>
                        <div class="preset-preview-item">Detail: <span id="previewDetail">Medium</span></div>
                        <div class="preset-preview-item">View: <span id="previewView">Low Top-Down</span></div>
                    </div>
                </div>
            </div>

            <!-- Asset Defaults -->
            <div class="settings-panel" id="settingsAssets">
                <div class="settings-section">
                    <div class="settings-section-title">Tile Defaults</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Tile Size</div>
                            <div class="settings-row-hint">Default size for new tiles</div>
                        </div>
                        <select class="settings-select" id="settingsTileSize">
                            <option value="16">16×16 px</option>
                            <option value="24">24×24 px</option>
                            <option value="32">32×32 px</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Transition Size</div>
                            <div class="settings-row-hint">Blend width for tileset transitions</div>
                        </div>
                        <select class="settings-select" id="settingsTransition">
                            <option value="sharp">Sharp (0%)</option>
                            <option value="medium">Medium (25%)</option>
                            <option value="wide">Wide (50%)</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Character Defaults</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Character Size</div>
                            <div class="settings-row-hint">Default sprite size for characters</div>
                        </div>
                        <input type="number" class="settings-number" id="settingsCharSize" value="32" min="16" max="128" step="8">
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-row-label">Directions</div>
                            <div class="settings-row-hint">Number of rotation angles</div>
                        </div>
                        <select class="settings-select" id="settingsDirections">
                            <option value="1">1 (No rotation)</option>
                            <option value="4">4 (Cardinal)</option>
                            <option value="8">8 (Full rotation)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn" id="cancelSettingsBtn">Cancel</button>
                <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Load Supabase Client -->
    <script src="../shared/supabase-client.js"></script>
    <script src="../shared/persistent-header.js"></script>
    <script src="../shared/notifications.js"></script>
    <script src="../shared/help-drawer.js"></script>
    <script src="../shared/docs/crucible-docs.js"></script>

    <script>
        /* ============================================
           CRUCIBLE OF CODE - Main Application
           ============================================ */

        // State
        const state = {
            projects: [],
            levels: [],
            currentProject: null,
            currentLevel: null,
            levelData: null
        };

        // Elements
        const elements = {
            projectSelect: document.getElementById('projectSelect'),
            newProjectBtn: document.getElementById('newProjectBtn'),
            projectInfo: document.getElementById('projectInfo'),
            exportProjectBtn: document.getElementById('exportProjectBtn'),
            levelsList: document.getElementById('levelsList'),
            newLevelBtn: document.getElementById('newLevelBtn'),
            emptyState: document.getElementById('emptyState'),
            dashboard: document.getElementById('dashboard'),
            configWarning: document.getElementById('configWarning'),
            levelTitle: document.getElementById('levelTitle'),
            levelSubtitle: document.getElementById('levelSubtitle'),
            gridStatus: document.getElementById('gridStatus'),
            bgStatus: document.getElementById('bgStatus'),
            tilesStatus: document.getElementById('tilesStatus'),
            spawnStatus: document.getElementById('spawnStatus'),
            gridPreview: document.getElementById('gridPreview'),
            bgPreview: document.getElementById('bgPreview'),
            tilesPreview: document.getElementById('tilesPreview'),
            jsonOutput: document.getElementById('jsonOutput'),
            toast: document.getElementById('toast'),
            // Modals
            newProjectModal: document.getElementById('newProjectModal'),
            newLevelModal: document.getElementById('newLevelModal'),
            newProjectName: document.getElementById('newProjectName'),
            newProjectDesc: document.getElementById('newProjectDesc'),
            newLevelName: document.getElementById('newLevelName'),
            newLevelType: document.getElementById('newLevelType'),
            newLevelWidth: document.getElementById('newLevelWidth'),
            newLevelHeight: document.getElementById('newLevelHeight'),
            // Invite
            inviteBtn: document.getElementById('inviteBtn'),
            inviteModal: document.getElementById('inviteModal'),
            inviteIdentifier: document.getElementById('inviteIdentifier'),
            membersList: document.getElementById('membersList'),
            // Settings
            projectSettingsBtn: document.getElementById('projectSettingsBtn'),
            projectSettingsModal: document.getElementById('projectSettingsModal'),
            settingsProjectName: document.getElementById('settingsProjectName'),
            settingsProjectDesc: document.getElementById('settingsProjectDesc'),
            settingsGameView: document.getElementById('settingsGameView'),
            settingsOutline: document.getElementById('settingsOutline'),
            settingsShading: document.getElementById('settingsShading'),
            settingsDetail: document.getElementById('settingsDetail'),
            settingsView: document.getElementById('settingsView'),
            settingsTileSize: document.getElementById('settingsTileSize'),
            settingsTransition: document.getElementById('settingsTransition'),
            settingsCharSize: document.getElementById('settingsCharSize'),
            settingsDirections: document.getElementById('settingsDirections'),
        };

        // =============================================
        // UTILITIES
        // =============================================

        function showToast(message, type = '') {
            elements.toast.textContent = message;
            elements.toast.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(() => elements.toast.classList.remove('show'), 3000);
        }

        function showModal(modal) {
            modal.classList.add('active');
        }

        function hideModal(modal) {
            modal.classList.remove('active');
        }

        // =============================================
        // PROJECT MANAGEMENT
        // =============================================

        async function loadProjects() {
            try {
                const crucible = await getCrucible();
                if (!crucible.isConfigured()) {
                    elements.configWarning.style.display = 'block';
                    return;
                }

                state.projects = await crucible.getProjects();
                renderProjectDropdown();

                // Check if we have a saved project context
                const ctx = crucible.getContext();
                if (ctx.projectId) {
                    elements.projectSelect.value = ctx.projectId;
                    await selectProject(ctx.projectId);
                }
            } catch (err) {
                console.error('Failed to load projects:', err);
                showToast('Failed to load projects', 'error');
            }
        }

        function renderProjectDropdown() {
            elements.projectSelect.innerHTML = '<option value="">Select Project...</option>';
            for (const project of state.projects) {
                const opt = document.createElement('option');
                opt.value = project.id;
                opt.textContent = project.name;
                elements.projectSelect.appendChild(opt);
            }
        }

        async function selectProject(projectId) {
            if (!projectId) {
                state.currentProject = null;
                state.levels = [];
                elements.projectInfo.innerHTML = '<div style="font-size: 12px; color: var(--stone-mid);">No project selected</div>';
                renderLevelsList();
                elements.newLevelBtn.disabled = true;
                elements.exportProjectBtn.disabled = true;
                elements.projectSettingsBtn.disabled = true;
                elements.inviteBtn.disabled = true;
                elements.membersList.style.display = 'none';
                showEmptyState();
                return;
            }

            try {
                const crucible = await getCrucible();
                state.currentProject = await crucible.getProject(projectId);
                state.levels = await crucible.getLevels(projectId);

                elements.projectInfo.innerHTML = `
                    <div style="font-size: 13px; color: var(--stone-bright);">${state.currentProject.name}</div>
                    <div style="font-size: 10px; color: var(--stone-mid); margin-top: 4px;">
                        ${state.levels.length} level${state.levels.length !== 1 ? 's' : ''}
                    </div>
                `;

                renderLevelsList();
                elements.newLevelBtn.disabled = false;
                elements.exportProjectBtn.disabled = false;
                elements.projectSettingsBtn.disabled = false;

                // Enable invite button if user is the owner
                const user = await crucible.getUser();
                const isOwner = user && state.currentProject.user_id === user.id;
                elements.inviteBtn.disabled = !isOwner;

                crucible.setContext(projectId, null, null);

                // Check if we have a saved level context
                const ctx = crucible.getContext();
                if (ctx.levelSlug) {
                    const level = state.levels.find(l => l.slug === ctx.levelSlug);
                    if (level) {
                        await selectLevel(level.id);
                        return;
                    }
                }

                // Select first level if exists
                if (state.levels.length > 0) {
                    await selectLevel(state.levels[0].id);
                } else {
                    showEmptyState();
                }
            } catch (err) {
                console.error('Failed to select project:', err);
                showToast('Failed to load project', 'error');
            }
        }

        async function createProject() {
            const name = elements.newProjectName.value.trim();
            if (!name) {
                showToast('Please enter a project name', 'error');
                return;
            }

            try {
                const crucible = await getCrucible();

                // Check auth before trying
                const user = await crucible.getUser();
                if (!user) {
                    showToast('Please log in to create a project', 'error');
                    return;
                }

                // Create project first
                const project = await crucible.createProject(name, elements.newProjectDesc.value);

                // Derive AI view setting from game view
                let aiView = 'low_top_down';
                if (wizardState.gameView === 'side-scroll') aiView = 'side';
                else if (wizardState.gameView === 'top-down') aiView = 'low_top_down';

                // Build settings from wizard choices
                const settings = {
                    gameView: wizardState.gameView,
                    pixellab: {
                        characterStyle: {
                            outline: wizardState.charOutline,
                            shading: wizardState.charShading,
                            detail: 'medium',
                            view: aiView
                        },
                        tileStyle: {
                            outline: wizardState.tileOutline,
                            shading: wizardState.tileShading,
                            detail: 'medium',
                            view: aiView
                        },
                        tileDefaults: {
                            size: 16,
                            transitionSize: 'medium'
                        },
                        characterDefaults: {
                            size: 32,
                            directions: wizardState.gameView === 'side-scroll' ? 1 : 4
                        }
                    }
                };

                // Update project with settings
                await crucible.updateProject(project.id, { settings });
                project.settings = settings;

                state.projects.unshift(project);
                renderProjectDropdown();
                elements.projectSelect.value = project.id;
                await selectProject(project.id);

                hideModal(elements.newProjectModal);
                resetWizard();

                showToast('Project created!', 'success');
            } catch (err) {
                console.error('Failed to create project:', err);
                showToast(err.message || 'Failed to create project', 'error');
            }
        }

        // =============================================
        // LEVEL MANAGEMENT
        // =============================================

        function renderLevelsList() {
            if (state.levels.length === 0) {
                elements.levelsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; font-size: 11px; color: var(--stone-mid);">
                        No levels yet. Create one!
                    </div>
                `;
                return;
            }

            elements.levelsList.innerHTML = state.levels.map(level => `
                <div class="level-item ${state.currentLevel?.id === level.id ? 'active' : ''}" data-level-id="${level.id}">
                    <div>
                        <div class="level-item-name">${level.name}</div>
                        <div class="level-item-meta">${level.width}x${level.height} • ${level.level_type}</div>
                    </div>
                    <button class="level-item-delete" data-delete-level="${level.id}" title="Delete level">&times;</button>
                </div>
            `).join('');

            // Add click handlers
            elements.levelsList.querySelectorAll('.level-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('level-item-delete')) return;
                    selectLevel(item.dataset.levelId);
                });
            });

            elements.levelsList.querySelectorAll('.level-item-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteLevel(btn.dataset.deleteLevel);
                });
            });
        }

        async function selectLevel(levelId) {
            try {
                const crucible = await getCrucible();
                const level = await crucible.getLevel(levelId);

                state.currentLevel = level;
                crucible.setContext(state.currentProject.id, levelId, level.slug);

                // Compile level data
                state.levelData = await crucible.compileLevel(levelId);

                renderLevelsList();
                showDashboard();
                updateDashboard();

            } catch (err) {
                console.error('Failed to select level:', err);
                showToast('Failed to load level', 'error');
            }
        }

        async function createLevel() {
            const name = elements.newLevelName.value.trim();
            if (!name) {
                showToast('Please enter a level name', 'error');
                return;
            }

            try {
                const crucible = await getCrucible();
                const level = await crucible.createLevel(
                    state.currentProject.id,
                    name,
                    elements.newLevelType.value,
                    parseInt(elements.newLevelWidth.value),
                    parseInt(elements.newLevelHeight.value)
                );

                state.levels.push(level);
                renderLevelsList();
                await selectLevel(level.id);

                hideModal(elements.newLevelModal);
                elements.newLevelName.value = '';

                showToast('Level created!', 'success');
            } catch (err) {
                console.error('Failed to create level:', err);
                showToast('Failed to create level', 'error');
            }
        }

        async function deleteLevel(levelId) {
            if (!confirm('Delete this level? This cannot be undone.')) return;

            try {
                const crucible = await getCrucible();
                await crucible.deleteLevel(levelId);

                state.levels = state.levels.filter(l => l.id !== levelId);
                renderLevelsList();

                if (state.currentLevel?.id === levelId) {
                    state.currentLevel = null;
                    if (state.levels.length > 0) {
                        await selectLevel(state.levels[0].id);
                    } else {
                        showEmptyState();
                    }
                }

                showToast('Level deleted', 'success');
            } catch (err) {
                console.error('Failed to delete level:', err);
                showToast('Failed to delete level', 'error');
            }
        }

        // =============================================
        // DASHBOARD
        // =============================================

        function showEmptyState() {
            elements.emptyState.style.display = 'flex';
            elements.dashboard.style.display = 'none';
        }

        function showDashboard() {
            elements.emptyState.style.display = 'none';
            elements.dashboard.style.display = 'block';
        }

        function updateDashboard() {
            if (!state.currentLevel || !state.levelData) return;

            const level = state.currentLevel;
            const data = state.levelData;

            // Header
            elements.levelTitle.textContent = level.name;
            elements.levelSubtitle.textContent = `${level.width}x${level.height} tiles • ${level.level_type}`;

            // Update tool links
            const baseUrl = `/game-wizard/level-forge/?project=${state.currentProject.id}&level=${level.slug}`;
            document.getElementById('openLevelForgeGrid').href = baseUrl + '&tab=grid';
            document.getElementById('openLevelForgeBg').href = baseUrl + '&tab=background';
            document.getElementById('openLevelForgeTiles').href = baseUrl + '&tab=tiles';

            // Grid Status
            const totalTiles = level.width * level.height;
            const definedTiles = (data.walkable?.length || 0) + (data.obstructions?.length || 0);
            const gridPercent = totalTiles > 0 ? Math.round((definedTiles / totalTiles) * 100) : 0;

            updateStatusCard(elements.gridStatus, {
                percent: gridPercent,
                value: gridPercent > 0 ? `${gridPercent}% defined` : 'Not defined',
                meta: `${data.obstructions?.length || 0} obstructions • ${data.walkable?.length || 0} walkable`
            });

            // Background Status
            const bgCount = data.backgrounds?.length || 0;
            updateStatusCard(elements.bgStatus, {
                percent: bgCount > 0 ? 100 : 0,
                value: bgCount > 0 ? `${bgCount} layer${bgCount !== 1 ? 's' : ''}` : 'No layers',
                meta: bgCount > 0 ? 'Parallax backgrounds' : 'Add parallax backgrounds'
            });

            // Tiles Status
            const tileCount = data.visualTiles?.length || 0;
            updateStatusCard(elements.tilesStatus, {
                percent: tileCount > 0 ? Math.min(100, Math.round((tileCount / totalTiles) * 100)) : 0,
                value: tileCount > 0 ? `${tileCount} tiles placed` : '0 tiles placed',
                meta: 'Paint sprites on grid'
            });

            // Spawn Status
            const hasSpawn = data.spawn !== null;
            updateStatusCard(elements.spawnStatus, {
                percent: hasSpawn ? 100 : 0,
                value: hasSpawn ? `(${data.spawn.x}, ${data.spawn.y})` : 'Not set',
                meta: 'Player start position'
            });
            elements.spawnStatus.classList.toggle('empty', !hasSpawn);

            // Update tab panels
            renderGridPreview();
            renderBgPreview();
            renderTilesPreview();
            renderJsonPreview();
        }

        function updateStatusCard(card, { percent, value, meta }) {
            card.querySelector('.status-bar-fill').style.width = percent + '%';
            card.querySelector('.status-card-value').textContent = value;
            card.querySelector('.status-card-meta').textContent = meta;
            card.classList.toggle('empty', percent === 0);
        }

        function renderGridPreview() {
            if (!state.levelData?.grid?.length) {
                elements.gridPreview.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--stone-mid); font-size: 11px;">
                        No grid data. Open in Level Forge to design collision.
                    </div>
                `;
                return;
            }

            const grid = state.levelData.grid;
            const cellSize = Math.max(4, Math.min(12, Math.floor(600 / grid[0].length)));

            elements.gridPreview.style.gridTemplateColumns = `repeat(${grid[0].length}, ${cellSize}px)`;
            elements.gridPreview.innerHTML = grid.map(row =>
                row.map(cell => {
                    let cls = 'grid-preview-cell';
                    if (cell === 1) cls += ' open';
                    else if (cell === 2) cls += ' obstruction';
                    else if (cell === 3) cls += ' spawn';
                    return `<div class="${cls}"></div>`;
                }).join('')
            ).join('');
        }

        function renderBgPreview() {
            if (!state.levelData?.backgrounds?.length) {
                elements.bgPreview.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--stone-mid); font-size: 11px; width: 100%;">
                        No background layers. Open in Level Forge to add parallax backgrounds.
                    </div>
                `;
                return;
            }

            elements.bgPreview.innerHTML = state.levelData.backgrounds.map(bg => `
                <div class="bg-layer-card">
                    <div class="bg-layer-thumb">
                        ${bg.imageSrc ? `<img src="${bg.imageSrc}" alt="${bg.name}">` : ''}
                    </div>
                    <div class="bg-layer-name">${bg.name}</div>
                    <div class="bg-layer-meta">Depth: ${bg.depth} • Scroll: ${bg.scrollRate}x</div>
                </div>
            `).join('');
        }

        function renderTilesPreview() {
            const tileCount = state.levelData?.visualTiles?.length || 0;
            if (tileCount === 0) {
                elements.tilesPreview.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--stone-mid); font-size: 11px;">
                        No visual tiles placed. Open in Level Forge to paint tiles.
                    </div>
                `;
                return;
            }

            elements.tilesPreview.innerHTML = `
                <div style="font-size: 12px; color: var(--stone-bright);">${tileCount} tiles placed</div>
                <div style="font-size: 11px; color: var(--stone-mid); margin-top: 8px;">
                    Open in Level Forge to view and edit visual tile placement.
                </div>
            `;
        }

        function renderJsonPreview() {
            elements.jsonOutput.textContent = JSON.stringify(state.levelData, null, 2);
        }

        function copyJson() {
            navigator.clipboard.writeText(JSON.stringify(state.levelData, null, 2));
            showToast('JSON copied to clipboard', 'success');
        }

        // =============================================
        // DATA TABS
        // =============================================

        document.querySelectorAll('.data-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.data-panel').forEach(p => p.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
            });
        });

        // =============================================
        // EVENT LISTENERS
        // =============================================

        elements.projectSelect.addEventListener('change', (e) => {
            const projectId = e.target.value;
            const projectName = e.target.options[e.target.selectedIndex]?.text || '';
            selectProject(projectId);
            // Sync to persistent header
            if (window.gwPersistentHeader) {
                window.gwPersistentHeader.setProject(projectId, projectName);
            }
        });

        // Wizard state
        const wizardState = {
            step: 1,
            gameView: 'side-scroll',
            charOutline: 'single_color_black',
            charShading: 'basic',
            tileOutline: 'no_outline',
            tileShading: 'basic'
        };

        elements.newProjectBtn.addEventListener('click', () => {
            // Reset wizard to step 1
            wizardState.step = 1;
            updateWizardStep(1);
            showModal(elements.newProjectModal);
            elements.newProjectName.focus();
        });

        document.getElementById('cancelProjectBtn').addEventListener('click', () => {
            hideModal(elements.newProjectModal);
            resetWizard();
        });

        // Wizard navigation
        document.getElementById('wizardNextBtn').addEventListener('click', () => {
            const name = elements.newProjectName.value.trim();
            if (!name) {
                showToast('Please enter a project name', 'error');
                elements.newProjectName.focus();
                return;
            }
            wizardState.step = 2;
            updateWizardStep(2);
        });

        document.getElementById('wizardBackBtn').addEventListener('click', () => {
            wizardState.step = 1;
            updateWizardStep(1);
        });

        function updateWizardStep(step) {
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach(el => {
                const stepNum = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (stepNum < step) el.classList.add('completed');
                if (stepNum === step) el.classList.add('active');
            });

            // Update panels
            document.getElementById('wizardStep1').classList.toggle('active', step === 1);
            document.getElementById('wizardStep2').classList.toggle('active', step === 2);
        }

        function resetWizard() {
            wizardState.step = 1;
            wizardState.gameView = 'side-scroll';
            wizardState.charOutline = 'single_color_black';
            wizardState.charShading = 'basic';
            wizardState.tileOutline = 'no_outline';
            wizardState.tileShading = 'basic';
            elements.newProjectName.value = '';
            elements.newProjectDesc.value = '';
            updateWizardStep(1);

            // Reset example card selections
            document.querySelectorAll('#viewExamples .example-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.value === 'side-scroll');
            });

            // Reset style option selections
            document.querySelectorAll('#charOutlineOptions .style-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === 'single_color_black');
            });
            document.querySelectorAll('#charShadingOptions .style-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === 'basic');
            });
            document.querySelectorAll('#tileOutlineOptions .style-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === 'no_outline');
            });
            document.querySelectorAll('#tileShadingOptions .style-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === 'basic');
            });
        }

        // Example card selection (game view)
        document.querySelectorAll('#viewExamples .example-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('#viewExamples .example-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                wizardState.gameView = card.dataset.value;
            });
        });

        // Style option selection - Character
        document.querySelectorAll('#charOutlineOptions .style-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#charOutlineOptions .style-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                wizardState.charOutline = opt.dataset.value;
            });
        });

        document.querySelectorAll('#charShadingOptions .style-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#charShadingOptions .style-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                wizardState.charShading = opt.dataset.value;
            });
        });

        // Style option selection - Tile
        document.querySelectorAll('#tileOutlineOptions .style-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#tileOutlineOptions .style-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                wizardState.tileOutline = opt.dataset.value;
            });
        });

        document.querySelectorAll('#tileShadingOptions .style-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#tileShadingOptions .style-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                wizardState.tileShading = opt.dataset.value;
            });
        });

        document.getElementById('createProjectBtn').addEventListener('click', createProject);

        elements.newLevelBtn.addEventListener('click', () => {
            showModal(elements.newLevelModal);
            elements.newLevelName.focus();
        });

        document.getElementById('cancelLevelBtn').addEventListener('click', () => {
            hideModal(elements.newLevelModal);
        });

        document.getElementById('createLevelBtn').addEventListener('click', createLevel);

        document.getElementById('copyJsonBtn').addEventListener('click', copyJson);
        document.getElementById('copyJsonBtn2').addEventListener('click', copyJson);

        document.getElementById('exportBtn').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(state.levelData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.currentLevel.slug}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Level exported!', 'success');
        });

        elements.exportProjectBtn.addEventListener('click', async () => {
            if (!state.currentProject) return;

            try {
                elements.exportProjectBtn.disabled = true;
                elements.exportProjectBtn.textContent = 'Compiling...';

                const crucible = await getCrucible();
                const projectData = await crucible.compileProject(state.currentProject.id);

                const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${state.currentProject.name.toLowerCase().replace(/\s+/g, '-')}-project.json`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Project exported!', 'success');
            } catch (err) {
                console.error('Failed to export project:', err);
                showToast('Failed to export project', 'error');
            } finally {
                elements.exportProjectBtn.disabled = false;
                elements.exportProjectBtn.innerHTML = '&#128230; Export Project';
            }
        });

        // Invite collaborator
        elements.inviteBtn.addEventListener('click', () => {
            showModal(elements.inviteModal);
            elements.inviteIdentifier.focus();
        });

        document.getElementById('cancelInviteBtn').addEventListener('click', () => {
            hideModal(elements.inviteModal);
            elements.inviteIdentifier.value = '';
        });

        document.getElementById('sendInviteBtn').addEventListener('click', async () => {
            const identifier = elements.inviteIdentifier.value.trim();
            if (!identifier) {
                showToast('Please enter an email or display name', 'error');
                return;
            }

            const btn = document.getElementById('sendInviteBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const crucible = await getCrucible();
                await crucible.inviteToProject(state.currentProject.id, identifier);
                showToast('Invite sent!', 'success');
                hideModal(elements.inviteModal);
                elements.inviteIdentifier.value = '';
            } catch (err) {
                console.error('Failed to send invite:', err);
                showToast(err.message || 'Failed to send invite', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Invite';
            }
        });

        // Close modals on overlay click
        [elements.newProjectModal, elements.newLevelModal, elements.inviteModal, elements.projectSettingsModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) hideModal(modal);
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideModal(elements.newProjectModal);
                hideModal(elements.newLevelModal);
                hideModal(elements.inviteModal);
                hideModal(elements.projectSettingsModal);
            }
        });

        // =============================================
        // PROJECT SETTINGS
        // =============================================

        // Settings tab switching
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                const panelId = 'settings' + tab.dataset.settingsTab.charAt(0).toUpperCase() + tab.dataset.settingsTab.slice(1);
                document.getElementById(panelId)?.classList.add('active');
            });
        });

        // Open settings modal
        elements.projectSettingsBtn.addEventListener('click', () => {
            if (!state.currentProject) return;
            loadSettingsIntoModal();
            showModal(elements.projectSettingsModal);
        });

        // Cancel settings
        document.getElementById('cancelSettingsBtn').addEventListener('click', () => {
            hideModal(elements.projectSettingsModal);
        });

        // Save settings
        document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
            await saveProjectSettings();
        });

        // Update preview on AI settings change
        ['settingsOutline', 'settingsShading', 'settingsDetail', 'settingsView'].forEach(id => {
            document.getElementById(id)?.addEventListener('change', updateStylePreview);
        });

        function loadSettingsIntoModal() {
            if (!state.currentProject) return;

            const settings = state.currentProject.settings || {};
            // Support new flat structure and legacy pixellab nesting
            const legacy = settings.pixellab || {};
            const style = settings.artStyle || legacy.defaultStyle || {};
            const tiles = settings.tileDefaults || legacy.tileDefaults || {};
            const chars = settings.characterDefaults || legacy.characterDefaults || {};

            // General
            elements.settingsProjectName.value = state.currentProject.name || '';
            elements.settingsProjectDesc.value = state.currentProject.description || '';
            elements.settingsGameView.value = settings.gameView || 'top-down';

            // AI Generation (Art Style)
            elements.settingsOutline.value = style.outline || 'single_color_black';
            elements.settingsShading.value = style.shading || 'basic';
            elements.settingsDetail.value = style.detail || 'medium';
            elements.settingsView.value = style.view || 'low_top_down';

            // Asset Defaults
            elements.settingsTileSize.value = tiles.size || '16';
            elements.settingsTransition.value = tiles.transitionSize || 'medium';
            elements.settingsCharSize.value = chars.size || 32;
            elements.settingsDirections.value = chars.directions || '4';

            updateStylePreview();
        }

        function updateStylePreview() {
            const labels = {
                outline: {
                    'none': 'None',
                    'single_color_black': 'Black',
                    'single_color_colored': 'Colored'
                },
                shading: {
                    'flat': 'Flat',
                    'basic': 'Basic',
                    'detailed': 'Detailed'
                },
                detail: {
                    'low': 'Low',
                    'medium': 'Medium',
                    'high': 'High'
                },
                view: {
                    'high_top_down': 'High Top-Down',
                    'low_top_down': 'Low Top-Down',
                    'side': 'Side View',
                    'isometric_thin': 'Isometric Thin',
                    'isometric_thick': 'Isometric Thick',
                    'isometric_block': 'Isometric Block'
                }
            };

            document.getElementById('previewOutline').textContent = labels.outline[elements.settingsOutline.value] || 'Black';
            document.getElementById('previewShading').textContent = labels.shading[elements.settingsShading.value] || 'Basic';
            document.getElementById('previewDetail').textContent = labels.detail[elements.settingsDetail.value] || 'Medium';
            document.getElementById('previewView').textContent = labels.view[elements.settingsView.value] || 'Low Top-Down';
        }

        async function saveProjectSettings() {
            if (!state.currentProject) return;

            const btn = document.getElementById('saveSettingsBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const crucible = await getCrucible();

                // Build settings object (flat structure, no pixellab wrapper)
                const settings = {
                    gameView: elements.settingsGameView.value,
                    artStyle: {
                        outline: elements.settingsOutline.value,
                        shading: elements.settingsShading.value,
                        detail: elements.settingsDetail.value,
                        view: elements.settingsView.value
                    },
                    tileDefaults: {
                        size: parseInt(elements.settingsTileSize.value),
                        transitionSize: elements.settingsTransition.value
                    },
                    characterDefaults: {
                        size: parseInt(elements.settingsCharSize.value),
                        directions: parseInt(elements.settingsDirections.value)
                    }
                };

                // Update project
                await crucible.updateProject(state.currentProject.id, {
                    name: elements.settingsProjectName.value.trim(),
                    description: elements.settingsProjectDesc.value.trim(),
                    settings
                });

                // Refresh project data
                state.currentProject = await crucible.getProject(state.currentProject.id);

                // Update UI
                elements.projectInfo.innerHTML = `
                    <div style="font-size: 13px; color: var(--stone-bright);">${state.currentProject.name}</div>
                    <div style="font-size: 10px; color: var(--stone-mid); margin-top: 4px;">
                        ${state.levels.length} level${state.levels.length !== 1 ? 's' : ''}
                    </div>
                `;

                // Update project dropdown
                const opt = elements.projectSelect.querySelector(`option[value="${state.currentProject.id}"]`);
                if (opt) opt.textContent = state.currentProject.name;

                hideModal(elements.projectSettingsModal);
                showToast('Settings saved!', 'success');
            } catch (err) {
                console.error('Failed to save settings:', err);
                showToast(err.message || 'Failed to save settings', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Settings';
            }
        }

        // =============================================
        // INITIALIZATION
        // =============================================

        async function init() {
            const crucible = await getCrucible();

            if (!crucible.isConfigured()) {
                elements.configWarning.style.display = 'block';
                showToast('Supabase not configured - see instructions', 'error');
            }

            // Initialize notifications
            if (typeof initNotifications === 'function') {
                await initNotifications('#headerActions');
            }

            await loadProjects();

            // Sync with persistent header project selection
            if (!state.currentProject && window.gwPersistentHeader) {
                const saved = window.gwPersistentHeader.getSelectedProject();
                if (saved?.projectId) {
                    elements.projectSelect.value = saved.projectId;
                    await selectProject(saved.projectId);
                }
            }

            // Listen for project changes from persistent header
            window.addEventListener('gw:projectChange', async (e) => {
                const { projectId } = e.detail;
                if (projectId && projectId !== state.currentProject?.id) {
                    elements.projectSelect.value = projectId;
                    await selectProject(projectId);
                }
            });
        }

        init();

        // Initialize help drawer
        if (typeof HelpDrawer !== 'undefined' && typeof CRUCIBLE_DOCS !== 'undefined') {
            HelpDrawer.init({
                toolId: 'crucible',
                toolName: 'Crucible of Code',
                toolIcon: '&#129514;',
                accentColor: '#ffa500',
                docs: CRUCIBLE_DOCS
            });
        }
    </script>
</body>
</html>
